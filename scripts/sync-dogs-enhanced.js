const fetch = require('node-fetch');
const zipcodes = require('zipcodes');

// Configuration
const PETFINDER_API_KEY = process.env.PETFINDER_API_KEY;
const PETFINDER_SECRET = process.env.PETFINDER_SECRET;
const RESCUEGROUPS_API_KEY = process.env.RESCUEGROUPS_API_KEY;

const IS_PRODUCTION = process.env.NODE_ENV === 'production';
const TEST_MODE = !IS_PRODUCTION; // Use test mode for development

// Function to get a random ZIP code from a given state
function getRandomZipInState(stateAbbreviation) {
  const zips = zipcodes.lookupByState(stateAbbreviation);
  if (zips.length === 0) return null;
  return zips[Math.floor(Math.random() * zips.length)].zip;
}

// Function to get a random rural ZIP code
function getRandomRuralZip() {
  const ruralZipCodes = [
    '82070', '82501', '83401', '83605', '83686', '83702', '83814', '83854',
    '59001', '59301', '59401', '59701', '59715', '59801', '59901',
    '58201', '58278', '58601', '58701',
    '57701', '57790', '57501', '57101',
    '69001', '68001', '68101', '68301', '68401', '68501', '68701', '68801',
    '66001', '66002', '66003', '66004', '66005', '66006', '66007', '66008', '66009', '66010', '66011', '66012', '66013', '66014', '66015', '66016', '66017', '66018', '66019', '66020', '66021', '66022', '66023', '66024', '66025', '66026', '66027', '66028', '66029', '66030', '66031', '66032', '66033', '66034', '66035', '66036', '66037', '66038', '66039', '66040', '66041', '66042', '66043', '66044', '66045', '66046', '66047', '66048', '66049', '66050', '66051', '66052', '66053', '66054', '66055', '66056', '66057', '66058', '66059', '66060', '66061', '66062', '66063', '66064', '66065', '66066', '66067', '66068', '66069', '66070', '66071', '66072', '66073', '66074', '66075', '66076', '66077', '66078', '66079', '66080', '66081', '66082', '66083', '66084', '66085', '66086', '66087', '66088', '66089', '66090', '66091', '66092', '66093', '66094', '66095', '66096', '66097', '66098', '66099',
    '50001', '50002', '50003', '50004', '50005', '50006', '50007', '50008', '50009', '50010', '50011', '50012', '50013', '50014', '50015', '50016', '50017', '50018', '50019', '50020', '50021', '50022', '50023', '50024', '50025', '50026', '50027', '50028', '50029', '50030', '50031', '50032', '50033', '50034', '50035', '50036', '50037', '50038', '50039', '50040', '50041', '50042', '50043', '50044', '50045', '50046', '50047', '50048', '50049', '50050', '50051', '50052', '50053', '50054', '50055', '50056', '50057', '50058', '50059', '50060', '50061', '50062', '50063', '50064', '50065', '50066', '50067', '50068', '50069', '50070', '50071', '50072', '50073', '50074', '50075', '50076', '50077', '50078', '50079', '50080', '50081', '50082', '50083', '50084', '50085', '50086', '50087', '50088', '50089', '50090', '50091', '50092', '50093', '50094', '50095', '50096', '50097', '50098', '50099',
    '71001', '71002', '71003', '71004', '71005', '71006', '71007', '71008', '71009', '71010', '71011', '71012', '71013', '71014', '71015', '71016', '71017', '71018', '71019', '71020', '71021', '71022', '71023', '71024', '71025', '71026', '71027', '71028', '71029', '71030', '71031', '71032', '71033', '71034', '71035', '71036', '71037', '71038', '71039', '71040', '71041', '71042', '71043', '71044', '71045', '71046', '71047', '71048', '71049', '71050', '71051', '71052', '71053', '71054', '71055', '71056', '71057', '71058', '71059', '71060', '71061', '71062', '71063', '71064', '71065', '71066', '71067', '71068', '71069', '71070', '71071', '71072', '71073', '71074', '71075', '71076', '71077', '71078', '71079', '71080', '71081', '71082', '71083', '71084', '71085', '71086', '71087', '71088', '71089', '71090', '71091', '71092', '71093', '71094', '71095', '71096', '71097', '71098', '71099',
    '39042', '39057', '39059', '39071', '39092', '39110', '39114', '39119', '39120', '39121', '39130', '39132', '39133', '39140', '39144', '39146', '39148', '39150', '39152', '39153', '39157', '39159', '39160', '39164', '39165', '39166', '39168', '39169', '39170', '39174', '39175', '39176', '39177', '39179', '39180', '39183', '39184', '39187', '39189', '39190', '39191', '39192', '39193', '39194', '39195', '39196', '39197', '39198', '39199',
    '42001', '42002', '42003', '42004', '42020', '42022', '42023', '42025', '42026', '42027', '42028', '42029', '42037', '42041', '42043', '42044', '42048', '42050', '42051', '42054', '42055', '42056', '42058', '42059', '42060', '42061', '42063', '42064', '42066', '42069', '42071', '42072', '42075', '42076', '42078', '42080', '42082', '42084', '42086', '42088', '42089', '42090',
    '41001', '41002', '41003', '41004', '41005', '41006', '41007', '41008', '41009', '41010', '41011', '41012', '41014', '41015', '41016', '41017', '41018', '41019', '41020', '41022', '41023', '41024', '41025', '41027', '41028', '41030', '41031', '41033', '41034', '41036', '41037', '41039', '41040', '41042', '41043', '41044', '41045', '41049', '41050', '41051', '41053', '41054', '41055', '41056', '41057', '41059', '41060', '41061', '41062', '41063', '41064', '41065', '41066', '41067', '41068', '41069', '41070', '41071', '41072', '41073', '41074', '41075', '41076', '41077', '41078', '41079', '41080', '41081', '41082', '41083', '41084', '41085', '41086', '41087', '41088', '41089',
    '46001', '46002', '46003', '46004', '46005', '46006', '46007', '46008', '46009', '46010', '46011', '46012', '46013', '46014', '46015', '46016', '46017', '46018', '46019', '46020', '46021', '46022', '46023', '46024', '46025', '46026', '46027', '46028', '46029', '46030', '46031', '46032', '46033', '46034', '46035', '46036', '46037', '46038', '46039', '46040', '46041', '46042', '46043', '46044', '46045', '46046', '46047', '46048', '46049', '46050', '46051', '46052', '46053', '46054', '46055', '46056', '46057', '46058', '46059', '46060', '46061', '46062', '46063', '46064', '46065', '46066', '46067', '46068', '46069', '46070', '46071', '46072', '46073', '46074', '46075', '46076', '46077', '46078', '46079', '46080', '46081', '46082', '46083', '46084', '46085', '46086', '46087', '46088', '46089',
    '45001', '45002', '45003', '45004', '45005', '45006', '45007', '45008', '45009', '45010', '45011', '45012', '45013', '45014', '45015', '45016', '45017', '45018', '45019', '45030', '45032', '45034', '45036', '45039', '45040', '45042', '45044', '45048', '45049', '45050', '45052', '45054', '45055', '45056', '45060', '45061', '45062', '45064', '45065', '45066', '45067', '45068', '45069', '45071', '45074',

    '24001', '24002', '24003', '24004', '24005', '24006', '24007', '24008', '24009', '24010', '24011', '24012', '24013', '24014', '24015', '24016', '24017', '24018', '24019', '24050', '24053', '24054', '24055', '24057', '24059', '24060', '24061', '24062', '24064', '24073', '24075', '24077', '24079', '24081', '24083', '24085', '24087', '24089', '24090', '24091', '24092', '24093', '24094', '24095', '24096', '24097', '24098', '24101', '24102', '24104', '24105', '24107', '24108', '24112', '24115', '24120', '24121', '24124', '24130', '24131', '24132', '24133', '24136', '24137', '24138', '24139', '24140', '24141', '24142', '24143', '24151', '24153', '24154', '24155', '24157', '24160', '24161', '24164', '24165', '24166', '24167', '24170', '24171', '24175', '24176', '24179', '24180', '24181', '24182', '24184', '24185', '24187', '24189', '24201', '24210', '24211', '24236', '24237', '24239', '24240', '24251', '24255', '24258', '24260', '24270', '24271', '24273', '24274', '24275', '24276', '24277', '24278', '24279', '24280', '24281', '24282', '24284', '24286', '24288', '24290', '24291', '24292', '24293', '24301', '24311', '24312', '24313', '24315', '24317', '24318', '24319', '24320', '24323', '24324', '24325', '24326', '24333', '24334', '24340', '24343', '24344', '24346', '24348', '24350', '24351', '24353', '24354', '24360', '24361', '24363', '24366', '24368', '24370', '24371', '24374', '24377', '24379', '24380', '24381', '24383', '24384', '24401', '24402', '24403', '24406', '24415', '24419', '24420', '24421', '24423', '24426', '24428', '24430', '24431', '24434', '24436', '24437', '24438', '24440', '24441', '24443', '24445', '24450', '24456', '24460', '24465', '24467', '24469', '24470', '24471', '24473', '24475', '24476', '24477', '24479', '24482', '24483', '24485', '24486', '24487', '24489', '24501', '24502', '24505', '24506', '24508', '24520', '24521', '24522', '24523', '24528', '24536', '24538', '24540', '24541', '24543', '24545', '24546', '24550', '24551', '24557', '24558', '24561', '24562', '24563', '24564', '24565', '24566', '24567', '24569', '24570', '24571', '24572', '24574', '24575', '24576', '24577', '24578', '24579', '24580', '24581', '24582', '24585', '24586', '24587', '24590', '24591', '24592', '24593', '24594', '24596', '24597', '24598', '24601', '24602', '24605', '24606', '24607', '24609', '24613', '24614', '24615', '24616', '24617', '24620', '24622', '24624', '24630', '24634', '24636', '24637', '24639', '24640', '24641', '24642', '24643', '24651', '24658', '25401', '25402', '25403', '25404', '25411', '25412', '25413', '25405', '25414', '25419', '25420', '25422', '25425', '25427', '25428', '25430', '25434', '25436', '25437', '25438', '25440', '25441', '25442', '25443', '25446', '25429', '25448', '25431', '25501', '25502', '25503', '25504', '25506', '25507', '25508', '25510', '25515', '25516', '25517', '25519', '25520', '25526', '25530', '25535', '25537', '25540', '25541', '25545', '25570', '25571', '25572', '25575', '25577', '25579', '25601', '25602', '25604', '25606', '25607', '25609', '25614', '25615', '25621', '25625', '25635', '25636', '25637', '25638', '25640', '25643', '25644', '25645', '25646', '25650', '25651', '25661', '25664', '25666', '25668', '25670', '25671', '25672', '25674', '25675', '25676', '25677', '25678', '25679', '25691', '25701', '25702', '25705', '25709', '25727', '25801', '25805', '25807', '25813', '25814', '25815', '25817', '25818', '25819', '25820', '25823', '25825', '25830', '25832', '25837', '25840', '25843', '25845', '25846', '25848', '25854', '25857', '25880', '30001', '30002', '30003', '30004', '30005', '30006', '30007', '30008', '30009', '30010', '30011', '30012', '30013', '30014', '30015', '30016', '30017', '30018', '30019', '30020', '30021', '30022', '30023', '30024', '30025', '30026', '30027', '30028', '30029', '30030', '30031', '30032', '30033', '30034', '30035', '30036', '30037', '30038', '30039', '30040', '30041', '30042', '30043', '30044', '30045', '30046', '30047', '30048', '30049', '30050', '30051', '30052', '30053', '30054', '30055', '30056', '30057', '30058', '30059', '30060', '30061', '30062', '30063', '30064', '30065', '30066', '30067', '30068', '30069', '30070', '30071', '30072', '30073', '30074', '30075', '30076', '30077', '30078', '30079', '30080', '30081', '30082', '30083', '30084', '30085', '30086', '30087', '30088', '30089', '30090', '30091', '30092', '30093', '30094', '30095', '30096', '30097', '30098', '30099',
    '29001', '29002', '29003', '29004', '29005', '29006', '29007', '29008', '29009', '29010', '29011', '29012', '29013', '29014', '29015', '29016', '29017', '29018', '29019', '29030', '29032', '29033', '29034', '29036', '29037', '29038', '29039', '29040', '29042', '29044', '29045', '29046', '29047', '29048', '29049', '29050', '29051', '29052', '29053', '29054', '29055', '29056', '29057', '29058', '29059', '29060', '29061', '29062', '29063', '29064', '29065', '29066', '29067', '29068', '29069', '29070', '29071', '29072', '29073', '29074', '29075', '29076', '29077', '29078', '29079', '29080', '29081', '29082', '29083', '29084', '29085', '29086', '29087', '29088', '29089', '29090', '29091', '29092', '29093', '29094', '29095', '29096', '29097', '29098', '29099',
    '38601', '38602', '38603', '38604', '38606', '38607', '38608', '38609', '38611', '38614', '38616', '38618', '38619', '38621', '38623', '38624', '38625', '38626', '38631', '38632', '38633', '38634', '38635', '38636', '38637', '38638', '38639', '38640', '38641', '38642', '38643', '38644', '38646', '38650', '38651', '38654', '38655', '38657', '38658', '38659', '38660', '38661', '38662', '38663', '38664', '38665', '38666', '38667', '38668', '38669', '38670', '38671', '38672', '38673', '38674', '38675', '38676', '38677', '38678', '38679', '38680', '38683', '38684', '38686', '38688', '38689', '38701', '38702', '38703', '38704', '38705', '38706', '38721', '38723', '38730', '38732', '38733', '38734', '38735', '38736', '38737', '38738', '38739', '38740', '38741', '38751', '38752', '38753', '38754', '38756', '38757', '38758', '38759', '38761', '38762', '38764', '38765', '38766', '38767', '38768', '38769', '38771', '38772', '38773', '38774', '38776', '38777', '38778', '38780', '38781', '38782', '38783', '38784', '38785', '38786', '38787', '38788', '38801', '38802', '38803', '38804', '38806', '38807', '38809', '38821', '38822', '38824', '38827', '38828', '38829', '38830', '38834', '38837', '38838', '38839', '38840', '38841', '38842', '38843', '38844', '38845', '38846', '38847', '38848', '38849', '38850', '38851', '38852', '38853', '38854', '38856', '38857', '38858', '38859', '38860', '38861', '38862', '38863', '38864', '38865', '38866', '38867', '38869', '38870', '38871', '38873', '38874', '38875', '38876', '38878', '38879', '38880', '38881', '38882', '38883', '38884', '38885', '38886', '38887', '38888', '38889', '38890', '38891', '38892', '38893', '38894', '38895', '38896', '38897', '38901', '38902', '38910', '38911', '38913', '38914', '38917', '38920', '38921', '38922', '38924', '38925', '38926', '38927', '38928', '38929', '38930', '38931', '38932', '38933', '38934', '38935', '38936', '38937', '38938', '38939', '38940', '38941', '38942', '38943', '38944', '38945', '38946', '38947', '38948', '38949', '38950', '38951', '38952', '38953', '38954', '38955', '38956', '38957', '38958', '38959', '38960', '38961', '38962', '38963', '38964', '38965', '38966', '38967', '38968', '38969', '38970', '38971', '38972', '38973', '38974', '38975', '38976', '38977', '38978', '38979', '38980', '38981', '38982', '38983', '38984', '38985', '38986', '38987', '38988', '38989', '38990', '38991', '38992', '38993', '38994', '38995', '38996', '38997', '38998', '38999',
    '61001', '61005', '61007', '61008', '61009', '61010', '61011', '61014', '61016', '61017', '61018', '61019', '61020', '61021', '61024', '61025', '61026', '61032', '61033', '61034', '61036', '61038', '61039', '61040', '61041', '61043', '61046', '61048', '61050', '61051', '61053', '61054', '61055', '61056', '61059', '61060', '61061', '61063', '61064', '61065', '61066', '61067', '61069', '61070', '61071', '61072', '61073', '61074', '61076', '61077', '61078', '61080', '61081', '61082', '61084', '61085', '61086', '61087', '61088', '61090', '61091', '61092', '61093', '61094', '61096', '61098', '61101', '61102', '61103', '61104', '61105', '61106', '61107', '61108', '61109', '61110', '61111', '61112', '61113', '61114', '61120', '61121', '61122', '61123', '61124', '61125', '61126', '61127', '61128', '61129', '61130', '61131', '61132', '61133', '61134', '61135', '61136', '61137', '61138', '61139', '61140', '61141', '61142', '61143', '61144', '61145', '61146', '61147', '61148', '61149', '61150', '61151', '61153', '61154', '61155', '61156', '61157', '61158', '61159', '61160', '61161', '61164', '61165', '61166', '61167', '61168', '61169', '61170', '61171', '61172', '61173', '61174', '61175', '61176', '61177', '61178', '61179', '61180', '61181', '61182', '61183', '61184', '61185', '61186', '61187', '61188', '61189', '61190', '61191', '61192', '61193', '61194', '61195', '61196', '61197', '61198', '61199',
    '49001', '49004', '49005', '49006', '49007', '49008', '49009', '49010', '49011', '49012', '49013', '49014', '49015', '49016', '49017', '49018', '49019', '49020', '49021', '49022', '49023', '49024', '49025', '49026', '49027', '49028', '49029', '49030', '49031', '49032', '49033', '49034', '49035', '49036', '49037', '49038', '49039', '49040', '49041', '49042', '49043', '49044', '49045', '49046', '49047', '49048', '49049', '49050', '49051', '49052', '49053', '49054', '49055', '49056', '49057', '49058', '49059', '49060', '49061', '49062', '49064', '49066', '49067', '49068', '49069', '49070', '49071', '49073', '49074', '49075', '49076', '49077', '49079', '49080', '49081', '49082', '49083', '49084', '49085', '49086', '49087', '49088', '49089', '49090', '49091', '49093', '49094', '49096', '49097', '49098', '49099', '49101', '49102', '49103', '49104', '49106', '49107', '49110', '49111', '49112', '49113', '49115', '49116', '49117', '49119', '49120', '49124', '49125', '49126', '49127', '49129', '49130', '49131', '49135', '49136', '49137', '49138', '49139', '49201', '49202', '49203', '49220', '49221', '49224', '49230', '49233', '49234', '49235', '49237', '49240', '49241', '49243', '49245', '49248', '49249', '49250', '49252', '49253', '49254', '49255', '49260', '49261', '49263', '49264', '49265', '49267', '49269', '49280', '49281', '49282', '49283', '49284', '49285', '49286', '49301', '49302', '49303', '49304', '49305', '49306', '49307', '49308', '49309', '49310', '49311', '49312', '49313', '49314', '49315', '49316', '49317', '49319', '49321', '49322', '49324', '49325', '49326', '49327', '49328', '49329', '49330', '49331', '49332', '49333', '49335', '49336', '49337', '49338', '49339', '49340', '49341', '49342', '49343', '49344', '49345', '49346', '49347', '49348', '49349', '49351', '49352', '49354', '49355', '49356', '49357', '49358', '49359', '49360', '49362', '49363', '49367', '49390', '49401', '49402', '49403', '49404', '49405', '49406', '49407', '49408', '49409', '49410', '49411', '49412', '49413', '49415', '49416', '49417', '49418', '49419', '49420', '49421', '49423', '49424', '49426', '49427', '49428', '49429', '49431', '49433', '49434', '49435', '49436', '49437', '49438', '49439', '49441', '49442', '49444', '49445', '49448', '49449', '49450', '49451', '49453', '49456', '49457', '49459', '49460', '49461', '49464', '49468', '49503', '49504', '49505', '49506', '49507', '49508', '49509', '49510', '49512', '49514', '49515', '49518', '49519', '49521', '49523', '49525', '49528', '49534', '49544', '49545', '49546', '49548', '49555', '49556', '49557', '49558', '49559', '49587', '49601', '49602', '49611', '49612', '49613', '49614', '49615', '49616', '49617', '49619', '49621', '49622', '49623', '49624', '49626', '49627', '49628', '49629', '49630', '49633', '49634', '49635', '49636', '49637', '49638', '49639', '49640', '49642', '49643', '49645', '49646', '49648', '49649', '49650', '49651', '49653', '49654', '49655', '49656', '49657', '49658', '49659', '49660', '49661', '49664', '49665', '49666', '49667', '49668', '49669', '49670', '49671', '49673', '49674', '49675', '49676', '49677', '49679', '49680', '49681', '49682', '49683', '49684', '49685', '49686', '49687', '49688', '49689', '49690', '49691', '49692', '49693', '49701', '49702', '49705', '49706', '49707', '49708', '49709', '49710', '49711', '49712', '49713', '49715', '49716', '49717', '49718', '49719', '49720', '49721', '49724', '49725', '49726', '49727', '49728', '49729', '49730', '49731', '49732', '49733', '49734', '49735', '49736', '49737', '49738', '49739', '49740', '49741', '49743', '49744', '49745', '49746', '49747', '49749', '49750', '49751', '49753', '49754', '49755', '49756', '49757', '49759', '49760', '49762', '49764', '49765', '49766', '49767', '49768', '49769', '49770', '49771', '49773', '49774', '49775', '49776', '49777', '49778', '49779', '49780', '49781', '49782', '49783', '49784', '49785', '49786', '49787', '49788', '49789', '49790', '49791', '49792', '49793', '49794', '49795', '49796', '49797', '49798', '49801', '49802', '49803', '49804', '49805', '49806', '49807', '49809', '49810', '49811', '49812', '49815', '49816', '49817', '49818', '49819', '49820', '49821', '49822', '49825', '49826', '49827', '49829', '49830', '49831', '49833', '49834', '49835', '49836', '49837', '49838', '49840', '49841', '49842', '49843', '49845', '49846', '49848', '49849', '49850', '49851', '49852', '49853', '49854', '49855', '49856', '49857', '49858', '49859', '49860', '49861', '49862', '49863', '49864', '49866', '49867', '49868', '49869', '49870', '49871', '49872', '49873', '49874', '49875', '49876', '49877', '49878', '49879', '49880', '49882', '49883', '49884', '49885', '49886', '49887', '49888', '49889', '49890', '49891', '49892', '49893', '49894', '49895', '49896', '49897', '49901', '49902', '49904', '49910', '49911', '49913', '49914', '49915', '49916', '49917', '49919', '49920', '49922', '49923', '49925', '49926', '49927', '49928', '49930', '49931', '49935', '49936', '49937', '49938', '49940', '49941', '49942', '49943', '49945', '49946', '49947', '49950', '49951', '49953', '49954', '49955', '49956', '49957', '49960', '49961', '49962', '49963', '49964', '49965', '49966', '49967', '49969', '49970', '49971', '54001', '54002', '54003', '54004', '54005', '54006', '54007', '54008', '54009', '54010', '54011', '54012', '54013', '54014', '54015', '54016', '54017', '54018', '54019', '54020', '54021', '54022', '54023', '54024', '54025', '54026', '54027', '54028', '54029', '54030', '54031', '54032', '54033', '54034', '54035', '54036', '54037', '54038', '54039', '54040', '54041', '54042', '54043', '54044', '54045', '54046', '54047', '54048', '54049', '54050', '54051', '54052', '54053', '54054', '54055', '54056', '54057', '54058', '54059', '54060', '54061', '54062', '54063', '54064', '54065', '54066', '54067', '54068', '54069', '54070', '54071', '54072', '54073', '54074', '54075', '54076', '54077', '54078', '54079', '54080', '54081', '54082', '54083', '54084', '54085', '54086', '54087', '54088', '54089', '54090', '54091', '54092', '54093', '54094', '54095', '54096', '54097', '54098', '54099', '54101', '54102', '54103', '54104', '54105', '54106', '54107', '54108', '54109', '54110', '54111', '54112', '54113', '54114', '54115', '54116', '54117', '54118', '54119', '54120', '54121', '54122', '54123', '54124', '54125', '54126', '54127', '54128', '54129', '54130', '54131', '54132', '54133', '54134', '54135', '54136', '54137', '54138', '54139', '54140', '54141', '54142', '54143', '54144', '54145', '54146', '54147', '54148', '54149', '54150', '54151', '54152', '54153', '54154', '54155', '54156', '54157', '54158', '54159', '54160', '54161', '54162', '54163', '54164', '54165', '54166', '54167', '54168', '54169', '54170', '54171', '54172', '54173', '54174', '54175', '54176', '54177', '54178', '54179', '54180', '54181', '54182', '54183', '54184', '54185', '54186', '54187', '54188', '54189', '54190', '54191', '54192', '54193', '54194', '54195', '54196', '54197', '54198', '54199', '54201', '54202', '54203', '54204', '54205', '54206', '54207', '54208', '54209', '54210', '54211', '54212', '54213', '54214', '54215', '54216', '54217', '54218', '54219', '54220', '54221', '54222', '54223', '54224', '54225', '54226', '54227', '54228', '54229', '54230', '54231', '54232', '54233', '54234', '54235', '54236', '54237', '54238', '54239', '54240', '54241', '54242', '54243', '54244', '54245', '54246', '54247', '54248', '54249', '54250', '54251', '54252', '54253', '54254', '54255', '54256', '54257', '54258', '54259', '54260', '54261', '54262', '54263', '54264', '54265', '54266', '54267', '54268', '54269', '54270', '54271', '54272', '54273', '54274', '54275', '54276', '54277', '54278', '54279', '54280', '54281', '54282', '54283', '54284', '54285', '54286', '54287', '54288', '54289', '54290', '54291', '54292', '54293', '54294', '54295', '54296', '54297', '54298', '54299',
  ];
  return ruralZipCodes[Math.floor(Math.random() * ruralZipCodes.length)];
}

// Function to get a random urban ZIP code
function getRandomUrbanZip() {
  const urbanZipCodes = [
    '90210', '10001', '60601', '75201', '94102', '80202', '33101', '20001', '02108', '98101',
    '97204', '53202', '30303', '44113', '70112', '32801', '77002', '78701', '21201', '48226',
    '35203', '55401', '27510', '40202', '73301', '46204', '50309', '67202', '85003', '33601',
    '37201', '19107', '90012', '60611', '80203', '75204', '94105', '33130', '20005', '02111',
    '98104', '97205', '53203', '30304', '44114', '70113', '32802', '77003', '78704', '21202',
    '48227', '35204', '55402', '27511', '40203', '73302', '46205', '50310', '67203', '85004',
    '33602', '37202', '19102', '90013', '60612', '80204', '75205', '94106', '33131', '20006',
    '02112', '98105', '97206', '53204', '30305', '44115', '70114', '32803', '77004', '78705',
    '21203', '48228', '35205', '55403', '27512', '40204', '73303', '46206', '50311', '67204',
    '85005', '33603', '37203', '19103',
  ];
  return urbanZipCodes[Math.floor(Math.random() * urbanZipCodes.length)];
}

async function getPetfinderToken() {
  const response = await fetch('https://api.petfinder.com/v2/oauth2/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `grant_type=client_credentials&client_id=${PETFINDER_API_KEY}&client_secret=${PETFINDER_SECRET}`,
  });
  const data = await response.json();
  return data.access_token;
}

async function searchPetfinder(location, animalType) {
  const token = await getPetfinderToken();
  const response = await fetch(`https://api.petfinder.com/v2/animals?location=${location}&type=${animalType}&limit=100`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  const data = await response.json();
  return data.animals;
}

async function searchRescueGroups(zipCode) {
  if (!RESCUEGROUPS_API_KEY) {
    console.log('RESCUEGROUPS_API_KEY not set. Skipping RescueGroups search.');
    return [];
  }

  const response = await fetch(`http://ws.api.rescuegroups.org/v2/animals/?key=${RESCUEGROUPS_API_KEY}&animalLocation=${zipCode}&petType=dog&count=100`);
  const data = await response.json();

  if (!data || !data.data) {
    console.log(`No data returned from RescueGroups for zip: ${zipCode}`);
    return [];
  }

  return data.data.map(animal => ({
    id: animal.id,
    name: animal.name,
    species: 'Dog',
    breed: animal.breeds.primary,
    age: animal.ageGroup,
    gender: animal.sex,
    size: animal.size,
    photos: animal.photos ? animal.photos.map(photo => photo.medium) : [],
    url: animal.url,
    location: animal.locations.address,
  }));
}


// Enhanced Dog Sync Script
async function syncDogsEnhanced() {
  console.log('Starting enhanced dog sync...');

  const petfinderLocations = [];
  const rescueGroupsLocations = [];

  // Configure locations based on test mode
  if (TEST_MODE) {
    // Test Mode: More RescueGroups rural coverage since users won't make live calls
    for (let i = 0; i < 3; i++) {
      rescueGroupsLocations.push(getRandomRuralZip());
    }
    petfinderLocations.push('Austin, TX'); // Single urban area for Petfinder

    console.log(`ðŸ¦® RescueGroups will search: ${rescueGroupsLocations.join(', ')} (rural)`);
    console.log(`ðŸ” Petfinder will search: ${petfinderLocations[0]} (urban)`);
  } else {
    // ðŸžï¸ RescueGroups: EXPANDED rural coverage (200 rural ZIPs)
    // Since users won't make live calls, we can be more aggressive with syncing
    console.log('ðŸžï¸ Generating rural locations for RescueGroups (invisible dog rescue priority)...');
    const ruralStates = [
      'WY', 'MT', 'ND', 'SD', 'NE', 'KS', 'OK', 'IA', 'MO', 'AR', 'LA', 'MS', 'AL', 'TN', 'KY',
      'IN', 'OH', 'WV', 'VA', 'NC', 'SC', 'GA', 'FL', 'ME', 'NH', 'VT', 'ID', 'UT', 'NV', 'AZ', 'NM'
    ];

    for (let i = 0; i < 200; i++) {
      const randomState = ruralStates[Math.floor(Math.random() * ruralStates.length)];
      const zip = getRandomZipInState(randomState);
      if (zip) {
        rescueGroupsLocations.push(zip);
      }
    }

    // Petfinder: Diverse urban and suburban locations
    const urbanStates = ['CA', 'NY', 'TX', 'IL', 'PA', 'FL', 'GA', 'NC', 'MI', 'OH']; // More populated states
    urbanStates.forEach(state => {
      // Add a couple of urban locations per state
      for (let i = 0; i < 2; i++) {
        const zip = getRandomZipInState(state);
        if (zip) {
          petfinderLocations.push(`${zip}, ${state}`);
        }
      }
    });
    // Add a few more general urban locations
    petfinderLocations.push('Austin, TX');
    petfinderLocations.push('Denver, CO');
    petfinderLocations.push('Seattle, WA');

    console.log(`ðŸžï¸ RescueGroups will search ${rescueGroupsLocations.length} locations.`);
    console.log(`ðŸ” Petfinder will search ${petfinderLocations.length} locations.`);
  }

  // --- RescueGroups Sync ---
  console.log('\n--- Syncing from RescueGroups ---');
  const allRescueGroupsDogs = [];
  for (const location of rescueGroupsLocations) {
    try {
      const dogs = await searchRescueGroups(location);
      allRescueGroupsDogs.push(...dogs);
      console.log(`Synced ${dogs.length} dogs from RescueGroups location: ${location}`);
      // Add a small delay to avoid hitting rate limits, though RescueGroups is more permissive
      await new Promise(resolve => setTimeout(resolve, 100));
    } catch (error) {
      console.error(`Error syncing from RescueGroups location ${location}:`, error.message);
    }
  }
  console.log(`Total dogs synced from RescueGroups: ${allRescueGroupsDogs.length}`);

  // --- Petfinder Sync ---
  console.log('\n--- Syncing from Petfinder ---');
  const allPetfinderDogs = [];
  for (const location of petfinderLocations) {
    try {
      const dogs = await searchPetfinder(location, 'dog');
      allPetfinderDogs.push(...dogs);
      console.log(`Synced ${dogs.length} dogs from Petfinder location: ${location}`);
      // Petfinder has stricter rate limits, so add a slightly longer delay
      await new Promise(resolve => setTimeout(resolve, 500));
    } catch (error) {
      console.error(`Error syncing from Petfinder location ${location}:`, error.message);
    }
  }
  console.log(`Total dogs synced from Petfinder: ${allPetfinderDogs.length}`);


  // --- Database Sync ---
  // Placeholder for database insertion logic
  console.log('\n--- Syncing to Database ---');
  console.log('Database sync logic would go here.');
  console.log(`Combined total dogs found: ${allRescueGroupsDogs.length + allPetfinderDogs.length}`);

  console.log('\nEnhanced dog sync completed.');
}

// Example usage (in a real scenario, this would be called by a scheduler or API endpoint)
// syncDogsEnhanced();

module.exports = { syncDogsEnhanced };